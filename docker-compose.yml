version: '3.9'

# =============================================================================
# Motorsports Management — Production Docker Compose
#
# Services:
#   postgres  — PostgreSQL 16 database
#   backend   — Node.js / Express API (multi-stage build)
#   frontend  — React / Vite SPA served by nginx (multi-stage build)
#
# Usage:
#   1. Copy .env.example to .env and fill in all required values.
#   2. docker compose up --build -d
#   3. Access the app at http://localhost (or your configured domain).
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # PostgreSQL database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: motorsports_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-motorsports}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-motorsports_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-motorsports} -d ${POSTGRES_DB:-motorsports_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # Do NOT expose port 5432 to the host in production; the backend reaches
    # postgres via the internal Docker network.

  # ---------------------------------------------------------------------------
  # Backend — Express API
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: motorsports_backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgresql://${POSTGRES_USER:-motorsports}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-motorsports_db}?schema=public
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-motorsports-uploads}
      S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL:-}
      PRESIGNED_URL_EXPIRES_IN: ${PRESIGNED_URL_EXPIRES_IN:-3600}
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ---------------------------------------------------------------------------
  # Frontend — React SPA served by nginx
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
      args:
        # The browser calls this URL directly, so it must be publicly reachable.
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:3000}
    container_name: motorsports_frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "${FRONTEND_PORT:-80}:80"
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# =============================================================================
# Named volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  internal:
    driver: bridge
